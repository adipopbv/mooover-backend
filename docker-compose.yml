version: '3.8'
services:
  auth-services:
    build:
      context: .
      dockerfile: ./services/auth-services/Dockerfile
    ports:
      - "8001:8000"
  user-services:
    build:
      context: .
      dockerfile: ./services/user-services/Dockerfile
    ports:
      - "8002:8000"
    environment:
      DB_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
  group-services:
    build:
      context: .
      dockerfile: ./services/group-services/Dockerfile
    ports:
      - "8003:8000"
    environment:
      DB_PASSWORD_FILE: /run/secrets/db_password
      USER_SERVICES_URL: http://user-services:8000/api/v1/users
    secrets:
      - db_password
  steps-services:
    build:
      context: .
      dockerfile: ./services/steps-services/Dockerfile
    ports:
      - "8004:8000"
    environment:
      DB_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-services
      - user-services
      - group-services
secrets:
  db_password:
    file: db_password.txt
